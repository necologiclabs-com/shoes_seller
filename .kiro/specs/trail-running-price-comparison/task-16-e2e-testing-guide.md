# Task 16: エンドツーエンド統合とテスト

## 概要

このドキュメントは、トレイルランニング価格比較サイトの完全なエンドツーエンド統合テストの手順を説明します。

## 前提条件

- バックエンド（Lambda関数、API Gateway、DynamoDB）がデプロイされていること
- フロントエンドがビルドされ、S3/CloudFrontにデプロイされていること
- 商品データがDynamoDBにシードされていること
- アフィリエイト設定がParameter Storeに保存されていること

## テスト環境の確認

### 1. バックエンドの確認

```powershell
# API Gatewayのエンドポイントを確認
aws cloudformation describe-stacks --stack-name PriceComparisonStack --query "Stacks[0].Outputs[?OutputKey=='ApiEndpoint'].OutputValue" --output text
```

### 2. フロントエンドの確認

```powershell
# CloudFrontのURLを確認
aws cloudformation describe-stacks --stack-name PriceComparisonStack --query "Stacks[0].Outputs[?OutputKey=='CloudFrontUrl'].OutputValue" --output text
```

### 3. DynamoDBのデータ確認

```powershell
# 商品データの確認
aws dynamodb scan --table-name PriceComparisonTable --filter-expression "begins_with(PK, :pk)" --expression-attribute-values '{":pk":{"S":"PRODUCT#"}}' --max-items 5
```

## Task 16.1: 完全なユーザーフローの手動テスト

### テストシナリオ 1: ホームページから商品一覧を表示

**手順:**

1. ブラウザでフロントエンドのURLにアクセス
2. ページが正常に読み込まれることを確認
3. 商品一覧が表示されることを確認

**期待される結果:**

- ✅ ページが3秒以内に読み込まれる
- ✅ ヘッダーに「トレイルランニングシューズ価格比較」が表示される
- ✅ サロモンの商品カードが複数表示される
- ✅ 各商品カードに画像、商品名、モデル番号が表示される
- ✅ レスポンシブデザインが適用されている（モバイル、タブレット、デスクトップ）

**検証項目:**

- [ ] ページタイトルが正しく表示される
- [ ] 商品画像が正しく読み込まれる
- [ ] ローディング状態が適切に表示される
- [ ] エラーがない（コンソールエラーを確認）

### テストシナリオ 2: 商品詳細ページへの遷移

**手順:**

1. 商品一覧から任意の商品カードをクリック
2. 商品詳細ページに遷移することを確認
3. URLが `/products/{productId}` の形式になることを確認

**期待される結果:**

- ✅ スムーズに商品詳細ページに遷移する
- ✅ 商品の詳細情報（画像、名前、モデル番号）が表示される
- ✅ 公式製品リンクが表示される
- ✅ 価格比較セクションが表示される

**検証項目:**

- [ ] ページ遷移がスムーズ（遅延なし）
- [ ] 商品情報が正確に表示される
- [ ] 公式リンクが正しいURL
- [ ] ブラウザの戻るボタンで商品一覧に戻れる

### テストシナリオ 3: 4つのプラットフォームの価格比較を表示

**手順:**

1. 商品詳細ページで価格比較セクションを確認
2. 4つのプラットフォーム（Amazon、楽天、ヨドバシ、メルカリ）の情報を確認
3. 各プラットフォームの価格、在庫状況、リンクを確認

**期待される結果:**

- ✅ 4つのプラットフォームカードが表示される
- ✅ 各カードにプラットフォームロゴと名前が表示される
- ✅ 価格が通貨フォーマット（¥X,XXX）で表示される
- ✅ 在庫状況が表示される（在庫あり/在庫なし/取扱なし）
- ✅ 最安値が視覚的にハイライトされる（緑色の背景など）
- ✅ 節約可能額が表示される
- ✅ 最終更新日時が表示される

**検証項目:**

- [ ] 価格データが正しく取得されている
- [ ] 最安値の判定が正確
- [ ] 節約額の計算が正確
- [ ] 日時フォーマットが適切
- [ ] ローディング状態が適切に表示される

### テストシナリオ 4: アフィリエイトリンクのクリック

**手順:**

1. 各プラットフォームの「購入する」ボタンをクリック
2. 新しいタブで外部サイトが開くことを確認
3. URLにアフィリエイトパラメータが含まれることを確認

**期待される結果:**

- ✅ クリックで新しいタブが開く（target="\_blank"）
- ✅ 正しいプラットフォームのサイトに遷移する
- ✅ URLにアフィリエイトIDが含まれる
- ✅ 商品ページに直接遷移する

**検証項目:**

- [ ] Amazon: URLに `tag=` パラメータが含まれる
- [ ] 楽天: URLに `affiliate_id=` パラメータが含まれる
- [ ] ヨドバシ: URLにトラッキングパラメータが含まれる
- [ ] メルカリ: URLにアフィリエイトパラメータが含まれる
- [ ] リンクが正しい商品ページに遷移する

### アクセシビリティテスト

**手順:**

1. キーボードのみでナビゲーション（Tabキー）
2. スクリーンリーダーでの読み上げ確認
3. 色コントラストの確認

**検証項目:**

- [ ] Tabキーで全ての要素にフォーカスできる
- [ ] Enterキーでリンクやボタンを操作できる
- [ ] フォーカス状態が視覚的に明確
- [ ] 画像にalt属性が設定されている
- [ ] ARIAラベルが適切に設定されている

### レスポンシブデザインテスト

**デバイス:**

- モバイル（375px）
- タブレット（768px）
- デスクトップ（1024px以上）

**検証項目:**

- [ ] 各デバイスで適切なレイアウト
- [ ] タッチ操作が快適（モバイル/タブレット）
- [ ] テキストが読みやすい
- [ ] 画像が適切にリサイズされる

## Task 16.2: 価格更新フローのテスト

### 手順 1: UpdatePricesFunction を手動でトリガー

```powershell
# Lambda関数を直接呼び出し
aws lambda invoke --function-name PriceComparisonStack-UpdatePricesFunction --payload '{}' response.json

# レスポンスを確認
Get-Content response.json | ConvertFrom-Json
```

### 手順 2: CloudWatch Logsで実行ログを確認

```powershell
# 最新のログストリームを確認
aws logs describe-log-streams --log-group-name /aws/lambda/PriceComparisonStack-UpdatePricesFunction --order-by LastEventTime --descending --max-items 1

# ログを表示（ログストリーム名を指定）
aws logs get-log-events --log-group-name /aws/lambda/PriceComparisonStack-UpdatePricesFunction --log-stream-name <LOG_STREAM_NAME>
```

### 手順 3: DynamoDBの価格データを確認

```powershell
# 特定商品の価格データを確認
aws dynamodb query --table-name PriceComparisonTable --key-condition-expression "PK = :pk AND begins_with(SK, :sk)" --expression-attribute-values '{":pk":{"S":"PRODUCT#salomon-speedcross-6"},":sk":{"S":"PRICE#"}}'
```

### 手順 4: フロントエンドで更新された価格を確認

1. ブラウザで商品詳細ページをリロード
2. 価格データが更新されていることを確認
3. 最終更新日時が最新になっていることを確認

**期待される結果:**

- ✅ UpdatePricesFunction が正常に実行される
- ✅ 全プラットフォームから価格が取得される
- ✅ DynamoDBに価格データが保存される
- ✅ フロントエンドに更新された価格が表示される
- ✅ エラーが発生した場合、適切にログに記録される

**検証項目:**

- [ ] Lambda関数が正常に完了（エラーなし）
- [ ] 各プラットフォームの価格取得が成功
- [ ] DynamoDBのlastUpdatedが更新されている
- [ ] フロントエンドの表示が更新される
- [ ] 失敗したプラットフォームがログに記録される

## Task 16.3: エラーシナリオのテスト

### シナリオ 1: ネットワークエラーのシミュレーション

**手順:**

1. ブラウザの開発者ツールを開く
2. Networkタブで「Offline」モードに設定
3. ページをリロードまたは商品をクリック

**期待される結果:**

- ✅ エラーメッセージが表示される
- ✅ 「リトライ」ボタンが表示される
- ✅ ユーザーフレンドリーなメッセージ

**検証項目:**

- [ ] エラーメッセージが明確
- [ ] リトライボタンが機能する
- [ ] アプリケーションがクラッシュしない

### シナリオ 2: 商品が見つからないケース

**手順:**

1. 存在しない商品IDでURLにアクセス（例: `/products/non-existent-product`）
2. 404エラーページが表示されることを確認

**期待される結果:**

- ✅ 「商品が見つかりません」メッセージが表示される
- ✅ ホームページに戻るリンクが表示される
- ✅ 適切な404ステータスコード

**検証項目:**

- [ ] エラーメッセージが表示される
- [ ] ナビゲーションリンクが機能する
- [ ] コンソールエラーがない

### シナリオ 3: プラットフォームが利用できないケース

**手順:**

1. DynamoDBで特定プラットフォームの価格データを削除または無効化
2. 商品詳細ページで価格比較を確認

**期待される結果:**

- ✅ 利用できないプラットフォームに「取扱なし」と表示される
- ✅ 他のプラットフォームの価格は正常に表示される
- ✅ 最安値の判定が正しく動作する

**検証項目:**

- [ ] 「取扱なし」が適切に表示される
- [ ] 他のプラットフォームに影響しない
- [ ] 最安値の計算が正確

### シナリオ 4: API タイムアウト

**手順:**

1. API Gatewayのタイムアウト設定を短くする（テスト用）
2. 価格データの取得をテスト

**期待される結果:**

- ✅ タイムアウトエラーメッセージが表示される
- ✅ リトライオプションが提供される

**検証項目:**

- [ ] タイムアウトが適切に処理される
- [ ] エラーメッセージが明確
- [ ] リトライが機能する

## テスト結果の記録

### テスト実行日時

- 日時: ******\_\_\_******
- 実行者: ******\_\_\_******
- 環境: ******\_\_\_******

### テスト結果サマリー

| テストケース                    | 結果              | 備考 |
| ------------------------------- | ----------------- | ---- |
| 16.1.1 商品一覧表示             | ⬜ Pass / ⬜ Fail |      |
| 16.1.2 商品詳細遷移             | ⬜ Pass / ⬜ Fail |      |
| 16.1.3 価格比較表示             | ⬜ Pass / ⬜ Fail |      |
| 16.1.4 アフィリエイトリンク     | ⬜ Pass / ⬜ Fail |      |
| 16.2 価格更新フロー             | ⬜ Pass / ⬜ Fail |      |
| 16.3.1 ネットワークエラー       | ⬜ Pass / ⬜ Fail |      |
| 16.3.2 商品が見つからない       | ⬜ Pass / ⬜ Fail |      |
| 16.3.3 プラットフォーム利用不可 | ⬜ Pass / ⬜ Fail |      |

### 発見された問題

1. **問題タイトル:**
   - 説明:
   - 再現手順:
   - 優先度: ⬜ High / ⬜ Medium / ⬜ Low

2. **問題タイトル:**
   - 説明:
   - 再現手順:
   - 優先度: ⬜ High / ⬜ Medium / ⬜ Low

## 次のステップ

- [ ] 全てのテストケースが Pass
- [ ] 発見された問題を修正
- [ ] パフォーマンステストを実施
- [ ] セキュリティテストを実施
- [ ] 本番環境へのデプロイ準備

## 参考資料

- Requirements: 1.2, 1.3, 1.4, 2.1, 2.3, 2.4, 2.5, 3.1, 4.2, 6.2
- Design Document: `.kiro/specs/trail-running-price-comparison/design.md`
- Deployment Guide: `DEPLOYMENT.md`
